---
# Job para inicializar la base de datos con tablas de ejemplo
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-init-schema
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: postgres-client
          image: postgres:16
          command:
            - /bin/bash
            - -c
            - |
              echo "ğŸ—ï¸  Inicializando esquema de base de datos..."
              echo "ğŸ“Š Creando tablas para API Gateway..."
              echo ""

              psql "postgresql://api_gateway_app:${DB_PASSWORD}@api-gateway-postgres.default.svc.cluster.local:5432/api_gateway_db" << 'EOF'

              -- Example users table
              CREATE TABLE IF NOT EXISTS users (
                  id SERIAL PRIMARY KEY,
                  username VARCHAR(50) UNIQUE NOT NULL,
                  email VARCHAR(100) UNIQUE NOT NULL,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
              );

              -- Tabla de posts/mensajes
              CREATE TABLE IF NOT EXISTS posts (
                  id SERIAL PRIMARY KEY,
                  user_id INTEGER REFERENCES users(id),
                  title VARCHAR(200) NOT NULL,
                  content TEXT,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
              );

              -- Insertar datos de ejemplo
              INSERT INTO users (username, email) VALUES 
                  ('admin', 'admin@apigateway.local'),
                  ('user1', 'user1@apigateway.local'),
                  ('user2', 'user2@apigateway.local')
              ON CONFLICT (username) DO NOTHING;

              INSERT INTO posts (user_id, title, content) VALUES 
                  (1, 'Welcome to API Gateway', 'This is the first post in our API Gateway backend!'),
                  (2, 'PostgreSQL is working', 'Successfully connected to Zalando PostgreSQL Operator'),
                  (3, 'Kubernetes deployment', 'Our API Gateway is now running with persistent storage')
              ON CONFLICT DO NOTHING;

              -- Mostrar resultados
              \echo 'ğŸ“Š Tablas creadas:'
              \dt

              \echo ''
              \echo 'ğŸ‘¥ Users:'
              SELECT id, username, email, created_at FROM users;

              \echo ''
              \echo 'ğŸ“ Posts:'
              SELECT p.id, u.username, p.title, p.created_at 
              FROM posts p 
              JOIN users u ON p.user_id = u.id;

              EOF

              echo ""
              echo "âœ… Esquema inicializado correctamente!"

          env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-gateway-app.api-gateway-postgres.credentials.postgresql.acid.zalan.do
                  key: password
