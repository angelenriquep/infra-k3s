---
# Job para probar la conectividad con PostgreSQL
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-connectivity-test
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: postgres-client
          image: postgres:16
          command:
            - /bin/bash
            - -c
            - |
              echo "ğŸ§ª Probando conectividad con PostgreSQL..."
              echo "ğŸ“¡ Host: api-gateway-postgres.default.svc.cluster.local:5432"
              echo "ğŸ—„ï¸  Database: api_gateway_db"
              echo "ğŸ‘¤ User: api_gateway_app"
              echo ""

              # Basic connectivity test
              pg_isready -h api-gateway-postgres.default.svc.cluster.local -p 5432 -U api_gateway_app

              echo ""
              echo "ğŸ” Ejecutando consulta de prueba..."

              # Version query
              psql "postgresql://api_gateway_app:${DB_PASSWORD}@api-gateway-postgres.default.svc.cluster.local:5432/api_gateway_db" \
                -c "SELECT version();" \
                -c "SELECT current_database(), current_user;" \
                -c "SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = 'public';"
                
              echo ""
              echo "âœ… Test completado!"

          env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-gateway-app.api-gateway-postgres.credentials.postgresql.acid.zalan.do
                  key: password
